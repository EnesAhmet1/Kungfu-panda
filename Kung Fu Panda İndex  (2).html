<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kung Fu Panda: ADİL ARENA (DÜZELTİLMİŞ)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const FairArenaGame = () => {
            // --- STATE (Görünüm için) ---
            const [gameState, setGameState] = useState('menu'); 
            const [scoreP1, setScoreP1] = useState(0);
            const [scoreP2, setScoreP2] = useState(0);
            const [timeLeft, setTimeLeft] = useState(30);
            const [countdown, setCountdown] = useState(3);
            const [cameraReady, setCameraReady] = useState(false);
            const [winner, setWinner] = useState(null);

            // --- REFLER (Oyun Döngüsü için - EN ÖNEMLİ KISIM) ---
            // Sorunu çözen kısım burası: Oyunun durumunu Ref içinde tutuyoruz
            const gameStateRef = useRef('menu'); 
            const targetSequenceRef = useRef([]); 
            const p1IndexRef = useRef(0);
            const p2IndexRef = useRef(0);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const handsRef = useRef(null);
            const timerRef = useRef(null);

            // --- KOORDİNATLAR ---
            const targetsP1 = [
                { id: 0, x: 150, y: 150 }, // Sol Üst
                { id: 1, x: 300, y: 150 }, // Sağ Üst
                { id: 2, x: 150, y: 350 }, // Sol Alt
                { id: 3, x: 300, y: 350 }  // Sağ Alt
            ];
            
            const targetsP2 = [
                { id: 0, x: 650, y: 150 }, // Sağ Üst
                { id: 1, x: 500, y: 150 }, // Sol Üst
                { id: 2, x: 650, y: 350 }, // Sağ Alt
                { id: 3, x: 500, y: 350 }  // Sol Alt
            ];

            // --- YARDIMCI FONKSİYONLAR ---
            const updateGameState = (newState) => {
                setGameState(newState);
                gameStateRef.current = newState; // Ref'i de güncelle ki loop görsün
            };

            const playSound = (type) => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                if (type === 'p1') osc.frequency.value = 600; 
                else if (type === 'p2') osc.frequency.value = 800; 
                else osc.frequency.value = 400;

                osc.type = 'square';
                gain.gain.value = 0.05;
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            };

            // --- BAŞLANGIÇ AYARLARI ---
            useEffect(() => {
                const init = async () => {
                    const hands = new window.Hands({
                        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                    });
                    
                    hands.setOptions({
                        maxNumHands: 2,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    
                    hands.onResults(onResults);
                    handsRef.current = hands;

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 800, height: 500 } });
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            const camera = new window.Camera(videoRef.current, {
                                onFrame: async () => {
                                    if (handsRef.current) await handsRef.current.send({ image: videoRef.current });
                                },
                                width: 800,
                                height: 500
                            });
                            camera.start();
                            setCameraReady(true);
                        }
                    } catch (e) {
                        alert("Kamera izni gerekli!");
                    }
                };
                init();
            }, []);

            // --- OYUN DÖNGÜSÜ (Drawing Loop) ---
            const onResults = (results) => {
                if (!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const W = canvasRef.current.width;
                const H = canvasRef.current.height;

                // 1. Ekranı Temizle ve Aynala
                ctx.save();
                ctx.clearRect(0, 0, W, H);
                ctx.scale(-1, 1);
                ctx.translate(-W, 0);
                ctx.drawImage(results.image, 0, 0, W, H);
                ctx.restore();

                // 2. UI ÇİZİMİ
                // Sol Bölge
                ctx.fillStyle = 'rgba(255, 200, 0, 0.1)';
                ctx.fillRect(0, 0, W/2, H);
                // Sağ Bölge
                ctx.fillStyle = 'rgba(0, 100, 255, 0.1)';
                ctx.fillRect(W/2, 0, W/2, H);
                // Orta Çizgi
                ctx.beginPath();
                ctx.moveTo(W/2, 0);
                ctx.lineTo(W/2, H);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 4;
                ctx.stroke();

                // 3. HEDEFLERİ ÇİZ (Ref kontrolü ile)
                if (gameStateRef.current === 'playing') {
                    
                    // P1 (Sarı) Hedefi
                    if (targetSequenceRef.current.length > 0 && p1IndexRef.current < targetSequenceRef.current.length) {
                        const targetId = targetSequenceRef.current[p1IndexRef.current];
                        const t = targetsP1[targetId];
                        drawTarget(ctx, t.x, t.y, '#fbbf24', 'SARI HEDEF');
                    }

                    // P2 (Mavi) Hedefi
                    if (targetSequenceRef.current.length > 0 && p2IndexRef.current < targetSequenceRef.current.length) {
                        const targetId = targetSequenceRef.current[p2IndexRef.current];
                        const t = targetsP2[targetId];
                        drawTarget(ctx, t.x, t.y, '#3b82f6', 'MAVİ HEDEF');
                    }
                }

                // 4. ELLERİ ÇİZ VE KONTROL ET
                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        const tip = landmarks[8];
                        const x = (1 - tip.x) * W; // Ayna koordinatı
                        const y = tip.y * H;

                        const isPlayer1 = x < W/2;
                        const color = isPlayer1 ? '#FACC15' : '#3B82F6';

                        // El İmleci
                        ctx.beginPath();
                        ctx.arc(x, y, 20, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 3;
                        ctx.stroke();

                        // Vuruş Kontrolü
                        if (gameStateRef.current === 'playing') {
                            if (isPlayer1) checkHitP1(x, y);
                            else checkHitP2(x, y);
                        }
                    }
                }
            };

            const drawTarget = (ctx, x, y, color, label) => {
                // Dış Halka (Animasyon efekti yerine sabit parlaklık)
                ctx.beginPath();
                ctx.arc(x, y, 45, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.8;
                ctx.fill();
                ctx.globalAlpha = 1.0;
                
                // Çerçeve
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 4;
                ctx.stroke();

                // İç Nokta
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
            };

            // --- VURUŞ MANTIĞI ---
            const checkHitP1 = (x, y) => {
                if (p1IndexRef.current >= targetSequenceRef.current.length) return;
                
                const targetId = targetSequenceRef.current[p1IndexRef.current];
                const t = targetsP1[targetId];
                const dist = Math.hypot(x - t.x, y - t.y);

                if (dist < 60) {
                    p1IndexRef.current += 1;
                    setScoreP1(p1IndexRef.current);
                    playSound('p1');
                }
            };

            const checkHitP2 = (x, y) => {
                if (p2IndexRef.current >= targetSequenceRef.current.length) return;

                const targetId = targetSequenceRef.current[p2IndexRef.current];
                const t = targetsP2[targetId];
                const dist = Math.hypot(x - t.x, y - t.y);

                if (dist < 60) {
                    p2IndexRef.current += 1;
                    setScoreP2(p2IndexRef.current);
                    playSound('p2');
                }
            };

            // --- OYUN YÖNETİMİ ---
            const generateFairSequence = () => {
                const seq = [];
                let last = -1;
                for(let i=0; i<100; i++) {
                    let next;
                    do { next = Math.floor(Math.random() * 4); } while(next === last);
                    seq.push(next);
                    last = next;
                }
                return seq;
            };

            const startCountdown = () => {
                updateGameState('countdown');
                setCountdown(3);
                
                let c = 3;
                const i = setInterval(() => {
                    c--;
                    setCountdown(c);
                    if (c <= 0) {
                        clearInterval(i);
                        startGame();
                    }
                }, 1000);
            };

            const startGame = () => {
                setScoreP1(0);
                setScoreP2(0);
                p1IndexRef.current = 0;
                p2IndexRef.current = 0;
                
                // Hedefleri oluştur
                targetSequenceRef.current = generateFairSequence();
                
                // Durumu güncelle
                updateGameState('playing');
                setTimeLeft(30);

                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            endGame();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            const endGame = () => {
                clearInterval(timerRef.current);
                updateGameState('gameover');
                
                // State değerleri loop içinde güncel olmayabilir, ref'ten okuyalım
                const s1 = p1IndexRef.current;
                const s2 = p2IndexRef.current;

                if (s1 > s2) setWinner('1. OYUNCU (SARI) KAZANDI!');
                else if (s2 > s1) setWinner('2. OYUNCU (MAVİ) KAZANDI!');
                else setWinner('BERABERE!');
            };

            return (
                <div className="min-h-screen bg-gray-900 flex flex-col items-center justify-center p-2 font-sans">
                    
                    {/* SKOR TABLOSU */}
                    <div className="flex w-full max-w-5xl mb-4 rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700">
                        <div className="flex-1 bg-yellow-400 p-4 flex flex-col items-center justify-center">
                            <h2 className="text-xl font-bold text-gray-800">1. OYUNCU (SOL)</h2>
                            <span className="text-7xl font-black text-gray-900">{scoreP1}</span>
                        </div>
                        <div className="bg-gray-800 p-6 flex flex-col items-center justify-center min-w-[180px] border-x-4 border-gray-700">
                            <span className="text-gray-400 font-bold mb-1">SÜRE</span>
                            <span className={`text-5xl font-mono font-bold ${timeLeft < 5 ? 'text-red-500 animate-pulse' : 'text-white'}`}>
                                {timeLeft}
                            </span>
                        </div>
                        <div className="flex-1 bg-blue-600 p-4 flex flex-col items-center justify-center">
                            <h2 className="text-xl font-bold text-white">2. OYUNCU (SAĞ)</h2>
                            <span className="text-7xl font-black text-white">{scoreP2}</span>
                        </div>
                    </div>

                    {/* OYUN ALANI */}
                    <div className="relative bg-black rounded-xl overflow-hidden shadow-2xl border-4 border-gray-700" style={{ width: '800px', height: '500px' }}>
                        <video ref={videoRef} className="hidden" />
                        <canvas ref={canvasRef} width={800} height={500} className="w-full h-full" />

                        {/* MENU */}
                        {gameState === 'menu' && (
                            <div className="absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center gap-6 z-10">
                                <h1 className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-blue-500">
                                    VS MODU
                                </h1>
                                <p className="text-gray-300 text-lg">İki oyuncu kamera karşısına geçin!</p>
                                <button 
                                    onClick={startCountdown}
                                    disabled={!cameraReady}
                                    className="bg-green-500 text-white px-12 py-5 rounded-full font-black text-2xl hover:scale-105 transition hover:bg-green-600 disabled:opacity-50 disabled:bg-gray-600"
                                >
                                    {cameraReady ? "BAŞLA" : "Kamera Yükleniyor..."}
                                </button>
                            </div>
                        )}

                        {/* GERİ SAYIM */}
                        {gameState === 'countdown' && (
                            <div className="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-20">
                                <div className="text-[150px] font-black text-white animate-ping">
                                    {countdown}
                                </div>
                            </div>
                        )}

                        {/* OYUN SONU */}
                        {gameState === 'gameover' && (
                            <div className="absolute inset-0 bg-black bg-opacity-95 flex flex-col items-center justify-center z-30 p-8 text-center">
                                <div className="text-5xl font-black text-yellow-400 mb-8 animate-bounce">
                                    {winner}
                                </div>
                                <div className="flex justify-center gap-12 text-3xl font-bold mb-8 w-full">
                                    <div className="text-yellow-400 bg-gray-800 px-6 py-3 rounded-xl border border-yellow-400">
                                        SARI: {scoreP1}
                                    </div>
                                    <div className="text-blue-400 bg-gray-800 px-6 py-3 rounded-xl border border-blue-400">
                                        MAVİ: {scoreP2}
                                    </div>
                                </div>
                                <button 
                                    onClick={() => updateGameState('menu')}
                                    className="bg-white hover:bg-gray-200 text-gray-900 px-10 py-4 rounded-xl font-bold text-xl transition"
                                >
                                    MENÜYE DÖN
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FairArenaGame />, document.getElementById('root'));
    </script>
</body>
</html>